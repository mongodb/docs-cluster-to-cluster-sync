.. _c2c-migrate-pqs:

=================================
Migrate Persistent Query Settings
=================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :class: singlecol
   :depth: 1

If your source cluster uses Persistent Query Settings (PQS), you must manually
migrate those settings to your destination cluster to finalize sync. 

``mongosync`` checks for PQS during the :ref:`cutover
process <c2c-cutover-process>`. If ``mongosync`` finds PQS on the source
cluster, {+c2c-product-name+} shows a warning. Use the following
procedure to address the warning and migrate your PQS to your
destination cluster.

Steps
-----

.. procedure::
   :style: normal

   .. step:: Export your Persistent Query Settings.

      Run the following code block to export your query settings into an array called ``querySettings``:

      .. code-block:: shell

         mongosh --eval 'console.log(db.aggregate([{$querySettings:{}}]).toArray())'

   .. step:: (Optional) Remove unwanted settings.

      If your source cluster contains query settings that you do not want to migrate to your destination cluster, remove those settings from your ``querySettings`` array. 

   .. step:: (Optional) Import your PQS to the desination cluster.

      For each query setting in your ``querySettings`` array, use
      :dbcommand:`setQuerySettings` to apply that setting to your destination
      cluster. 
      
      If the query setting includes a ``representativeQuery`` field, use that field value as the ``setQuerySettings`` value. 
      
      Otherwise, use the ``queryShapeHas`` field value from the
      ``querySettings`` array as the ``setQuerySettings`` value. 

